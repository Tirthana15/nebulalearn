
<?php require_once 'functions.php'; if (!isLoggedIn() || !isTeacher()) { header('HTTP/1.1 403 Forbidden'); echo json_encode(['success' => false, 'message' => 'Access denied']); exit; } $title = sanitizeInput($_POST['title']); $subject = sanitizeInput($_POST['subject']); $class = sanitizeInput($_POST['class']); $form = sanitizeInput($_POST['form']); $description = sanitizeInput($_POST['description']); $teacherId = $_SESSION['user_id']; // Handle file upload $targetDir = "uploads/materials/"; if (!file_exists($targetDir)) { mkdir($targetDir, 0777, true); } $fileName = basename($_FILES["file"]["name"]); $targetFile = $targetDir . uniqid() . '_' . $fileName; $fileType = strtolower(pathinfo($targetFile, PATHINFO_EXTENSION)); // Check if file is a valid type $allowedTypes = ['pdf', 'doc', 'docx', 'ppt', 'pptx', 'txt']; if (!in_array($fileType, $allowedTypes)) { echo json_encode(['success' => false, 'message' => 'Only PDF, DOC, PPT, and TXT files are allowed']); exit; } // Upload file if (move_uploaded_file($_FILES["file"]["tmp_name"], $targetFile)) { global $conn; // Save to database $stmt = $conn->prepare("INSERT INTO learning_materials (title, subject, file_path, teacher_id, class, form, description) VALUES (?, ?, ?, ?, ?, ?, ?)"); $stmt->bind_param("sssisis", $title, $subject, $targetFile, $teacherId, $class, $form, $description); if ($stmt->execute()) { echo json_encode(['success' => true]); } else { unlink($targetFile); // Delete the uploaded file if DB insert fails echo json_encode(['success' => false, 'message' => 'Error saving material']); } } else { echo json_encode(['success' => false, 'message' => 'Error uploading file']); } ?>